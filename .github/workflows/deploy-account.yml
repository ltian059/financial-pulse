name: Deploy Account Service

on:
  push:
    branches: [ master ]
    paths:
      - 'fp-account/**'
      - 'fp-common/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'account-dev'
        type: choice
        options:
          - account-dev
          - account-test
          - account-prod

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      jar-name: ${{steps.build.outputs.jar-name}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven
        id: build
        run: |
          # First install the parent POM
          mvn clean install -N
          # Then install fp-common
          mvn clean install -pl fp-common -DskipTests
          # Finally build fp-account
          mvn clean package -pl fp-account -DskipTests
          JAR_NAME=$(ls fp-account/target/fp-account-*.jar | head -1 | xargs basename)
          echo "jar-name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "Built JAR: $JAR_NAME"

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: account-service-jar
          path: fp-account/target/fp-account-*.jar
          retention-days: 1

  validate-and-deploy:
    runs-on: ubuntu-latest
    needs: [ build ]
    # The Environment currently deploying to
    environment: ${{ github.event.inputs.environment || 'account-dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML

      - name: Validate configuration templates
        run: |
          echo "üîç Validating configuration templates against workflow variables..."
          python scripts/validate-env-vars.py account

      - name: Determine Spring Profile
        id: profile
        run: |
          ENV_NAME="${{ github.event.inputs.environment || 'account-dev' }}"
          SPRING_PROFILE=${ENV_NAME#*-} # Remove 'account-' prefix
          echo "Environment: $ENV_NAME"
          echo "Spring Profile: $SPRING_PROFILE"
          echo "profile=$SPRING_PROFILE" >> $GITHUB_OUTPUT

      - name: Create environment configuration
        run: |
          echo "üìù Creating environment configuration..."
          cat > .env << 'EOF'
          # Application Configuration
          SPRING_PROFILES_ACTIVE=${{ steps.profile.outputs.profile }}
          # JWT Configuration
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          # AWS Configuration
          AWS_REGION=${{ vars.AWS_REGION }}
          # Server port
          SERVER_PORT=8080
          # DynamoDB configuration
          DYNAMODB_TABLE_PREFIX=${{ vars.DYNAMODB_TABLE_PREFIX }}
          DYNAMODB_TABLE_SUFFIX=${{ vars.DYNAMODB_TABLE_SUFFIX }}
          # SQS Configuration
          SQS_EMAIL_QUEUE_URL=${{ vars.SQS_EMAIL_QUEUE_URL }}
          SQS_FOLLOWER_NOTIFICATION_QUEUE_URL=${{ vars.SQS_FOLLOWER_NOTIFICATION_QUEUE_URL }}
          SQS_DEAD_LETTER_QUEUE_URL=${{ vars.SQS_DEAD_LETTER_QUEUE_URL }}
          AWS_SQS_ENABLED=true
          # SES Configuration
          AWS_SES_FROM_EMAIL=${{ secrets.AWS_SES_FROM_EMAIL }}
          EOF
  
          echo "‚úÖ Environment configuration created"

      - name: Validate actual environment file
        run: |
          echo "üîç Validating actual environment variables..."
          python scripts/validate-env-file.py .env

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/fp-keypair.pem
          chmod 600 /tmp/fp-keypair.pem
          

      - name: Prepare deployment scripts
        run: |
          # Copy Python scripts from repository and make them executable
          cp scripts/account-start.py start.py
          cp scripts/account-stop.py stop.py
          chmod +x start.py stop.py
          echo "‚úÖ Python deployment scripts prepared"

      - name: Upload files to S3
        run: |
          BUCKET_NAME="financial-pulse-deployment-artifacts"
          JAR_NAME=${{ needs.build.outputs.jar-name }}
          S3_JAR_KEY="account/fp-account-${{ github.sha }}.jar"
          S3_ENV_KEY="account/.env-${{ github.sha }}"
          
          echo "üì§ Uploading files to S3..."
          aws s3 cp ./artifacts/account-service-jar/$JAR_NAME s3://$BUCKET_NAME/$S3_JAR_KEY
          aws s3 cp .env s3://$BUCKET_NAME/$S3_ENV_KEY
          aws s3 cp start.py s3://$BUCKET_NAME/account/start.py
          aws s3 cp stop.py s3://$BUCKET_NAME/account/stop.py
          echo "‚úÖ All files uploaded to S3"

      - name: Deploy via SSH through EC2 Instance Connect
        run: |
          INSTANCE_ID="${{ vars.EC2_ACCOUNT_INSTANCE_ID }}"
          
          echo "üîó Connecting to EC2 instance $INSTANCE_ID via Instance Connect Endpoint"
          
          # SSH with ProxyCommand to use EC2 Instance Connect Endpoint
          ssh -i /tmp/fp-keypair.pem ec2-user@$INSTANCE_ID \
          -o ProxyCommand="aws ec2-instance-connect open-tunnel --instance-id $INSTANCE_ID" \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          << 'SSH_COMMANDS'
          
          set -e
          
          echo "=== Financial Pulse Deployment Starting ==="
          cd /opt/app
          
          echo "üì• Downloading from S3..."
          aws s3 cp s3://financial-pulse-deployment-artifacts/account/fp-account-${{ github.sha }}.jar ./fp-account.jar
          aws s3 cp s3://financial-pulse-deployment-artifacts/account/.env-${{ github.sha }} ./.env
          aws s3 cp s3://financial-pulse-deployment-artifacts/account/start.py ./start.py
          aws s3 cp s3://financial-pulse-deployment-artifacts/account/stop.py ./stop.py
          
          echo "üîß Setting permissions..."
          chmod +x start.py stop.py
          chmod 644 .env fp-account.jar
          
          echo "üõë Stopping existing service..."
          python3 stop.py || true
          
          echo "‚ñ∂Ô∏è Starting new service..."
          python3 start.py
          
          echo "‚è≥ Waiting for service to initialize..."
          sleep 10
          
          echo "üîç Checking service status..."
          if pgrep -f "fp-account.jar"; then 
            echo "‚úÖ Service started successfully"
            echo "Service PID: $(pgrep -f 'fp-account.jar')"
          else 
            echo "‚ùå Service failed to start"
            echo "Checking logs:"
            tail -20 /opt/app/app.log || echo "No logs found"
            exit 1
          fi
          
          echo "üè• Performing health check..."
          for i in {1..10}; do
            if curl -f http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              break
            else
              echo "‚è≥ Health check attempt $i/10..."
              sleep 3
            fi
            
            if [ $i -eq 10 ]; then
              echo "‚ùå Health check failed after 10 attempts"
              exit 1
            fi
          done
          
          echo "=== Deployment completed successfully ==="
          SSH_COMMANDS