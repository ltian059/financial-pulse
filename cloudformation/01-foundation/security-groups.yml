AWSTemplateFormatVersion: '2010-09-09'
Description: 'Financial Pulse Shared Security Groups'

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, test, prod]

  VPCStackName:
    Type: String
    Default: fp-vpc-dev
    Description: VPC Stack name to import VPC ID

Resources:
  # Common Application Security Group (for all services)
  ApplicationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Common security group for all application services
      VpcId:
        Fn::ImportValue: !Sub ${VPCStackName}-VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8082
          CidrIpv6: '::/0'
          Description: "HTTP from Internet via IPv6 (for API Gateway integration)"
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId:
            Fn::ImportValue: !Sub ${VPCStackName}-VPCEndpointSecurityGroupId
          Description: "SSH access from VPC Endpoint (for EC2 Instance Connect)"
      Tags:
        - Key: Name
          Value: !Sub fp-app-sg-${Environment}

  # Database Security Group
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Aurora PostgreSQL
      VpcId:
        Fn::ImportValue: !Sub ${VPCStackName}-VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref ApplicationSecurityGroup
          Description: PostgreSQL access from application servers

        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0
          Description: PostgreSQL access from admin IP for development
      Tags:
        - Key: Name
          Value: !Sub fp-db-sg-${Environment}

  # Allow inter-service communication
  ApplicationSecurityGroupIngressSelf:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ApplicationSecurityGroup
      IpProtocol: tcp
      FromPort: 8080
      ToPort: 8090
      SourceSecurityGroupId: !Ref ApplicationSecurityGroup
      Description: Inter-service communication

Outputs:
  ApplicationSecurityGroupId:
    Description: Application Security Group ID
    Value: !Ref ApplicationSecurityGroup
    Export:
      Name: !Sub ${AWS::StackName}-ApplicationSecurityGroupId

  DatabaseSecurityGroupId:
    Description: Database Security Group ID
    Value: !Ref DatabaseSecurityGroup
    Export:
      Name: !Sub ${AWS::StackName}-DatabaseSecurityGroupId

